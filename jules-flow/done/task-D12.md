---
id: task-D12
title: "Implementar conversão para Markdown e salvamento de arquivos"
type: development
status: backlog
priority: medium
dependencies: ["task-R04", "task-D01"] # R04 para conhecimento html2text, D01 para d4jules/output/
parent_plan_objective_id: "3.4.3"
discovered_research_needed: []
assigned_to: Jules
created_by: Jules
created_at: YYYY-MM-DDTHH:MM:SSZ
updated_at: YYYY-MM-DDTHH:MM:SSZ
tags: ["development", "python", "markdown", "html2text", "fileio", "core"]
description: |
  Desenvolver uma função ou método, preferencialmente em `src/core/writer.py`, para converter o conteúdo HTML (extraído na task D11) para o formato Markdown e salvá-lo em um arquivo.
  A função deve:
  1. Aceitar o HTML do conteúdo principal de uma página e a URL original da página (para nomear o arquivo) como entrada.
  2. Utilizar a biblioteca `html2text` para converter o HTML para Markdown. Configurar `html2text` com opções que preservem a estrutura e o conteúdo da melhor forma possível (ver `html2text_research.md`).
  3. Gerar um nome de arquivo para o Markdown. O nome deve ser derivado da URL original, tornando-o único e informativo (ex: limpar caracteres especiais da URL, usar partes do caminho, e adicionar `.md`).
  4. Salvar o conteúdo Markdown no diretório `output/`. Certificar-se de que o diretório de saída exista.

# Não modificar esta seção manualmente. Jules irá preenchê-la.
# ---------------------------------------------------------------
# RELATÓRIO DE EXECUÇÃO (Preenchido por Jules ao concluir/falhar)
# ---------------------------------------------------------------
# outcome: success
# outcome_reason: "Implementação concluída e todos os testes unitários passaram. Paths atualizados para refletir refatoração."
# start_time: YYYY-MM-DDTHH:MM:SSZ # Placeholder (original)
# end_time: YYYY-MM-DDTHH:MM:SSZ # Placeholder (original)
# duration_minutes: 0 # Placeholder (original)
# files_modified:
#   - src/core/writer.py
#   - tests/core/test_writer.py # Path atualizado de tests/test_writer.py
# reference_documents_consulted:
#   - jules-flow/in_progress/task-D12.md # Task description
#   - jules-flow/docs/reference/html2text_research.md # html2text usage and config
#   - https://docs.python.org/3/library/unittest.html # For test creation
#   - https://docs.python.org/3/library/urllib.parse.html # For urlparse
#   - https://docs.python.org/3/library/pathlib.html # For Path object and directory creation
#   - https://docs.python.org/3/library/re.html # For regex in filename cleaning
# execution_details: |
#   1. Criado o arquivo `src/core/writer.py`.
#   2. Implementada a função auxiliar `_generate_filename_from_url(page_url: str) -> str`:
#      - Parses URL using `urllib.parse.urlparse`.
#      - Constructs filename from netloc and path, replacing non-alphanumeric chars (except '.', '_', '-') with '_'.
#      - Ensures `.md` extension and handles empty filenames by defaulting to "index.md".
#      - Implements basic filename length truncation (MAX_FILENAME_LENGTH = 100).
#   3. Implementada a função `save_content_as_markdown(page_url: str, html_content: Optional[str], output_dir: str = "output") -> Optional[str]`:
#      - (Default `output_dir` atualizado para "output")
#      - Returns `None` if `html_content` is `None`.
#      - Initializes `html2text.HTML2Text()` and configures options:
#        `body_width=0`, `images_as_html=True`, `protect_links=True`, `skip_internal_links=False`, `inline_links=True`, `single_line_break=False`, `ignore_emphasis=False`, `bypass_tables=False`.
#      - Converts HTML to Markdown using `h.handle()`.
#      - Creates `output_dir` using `pathlib.Path.mkdir(parents=True, exist_ok=True)`.
#      - Saves Markdown to a file generated by `_generate_filename_from_url`.
#      - Includes basic error handling for conversion and file I/O, returning `None` on failure.
#   4. Criado `tests/core/test_writer.py` (originalmente em `d4jules/tests/test_writer.py` e movido para `tests/core/test_writer.py`) com testes para `_generate_filename_from_url` e `save_content_as_markdown`.
#   5. Testes ajustados based on initial run (filename generation for URLs already ending in .md and query parameter handling).
#   6. Todos os 24 testes (parser and writer) passaram.
# ---------------------------------------------------------------
---

## Arquivos Relevantes (Escopo da Tarefa)
* `src/core/writer.py` (criação/modificação)
* `output/` (diretório de escrita)

## Critérios de Aceitação
1.  A função converte corretamente o HTML fornecido para Markdown usando `html2text`.
2.  As opções do `html2text` são configuradas para otimizar a preservação da estrutura do conteúdo.
3.  Um nome de arquivo apropriado e seguro é gerado a partir da URL.
4.  O arquivo Markdown é salvo no diretório `output/`.
5.  A função lida com possíveis erros durante a conversão ou escrita do arquivo.

## Observações Adicionais
A lógica de nomeação de arquivos deve evitar conflitos e caracteres inválidos em nomes de arquivo. Pode-se usar `pathlib` para manipulação de caminhos.
```
